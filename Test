import os
import cv2

# Biến toàn cục để lưu trữ vị trí của vùng chọn
drawing = False  # True nếu chuột đang được nhấn
ix, iy = -1, -1  # Tọa độ điểm bắt đầu của hình chữ nhật

# Hàm callback cho sự kiện chuột
def draw_rectangle(event, x, y, flags, param):
    global ix, iy, drawing

    # Khi nhấn chuột trái
    if event == cv2.EVENT_LBUTTONDOWN:
        drawing = True
        ix, iy = x, y

    # Khi chuột đang di chuyển và chuột trái đang được nhấn
    elif event == cv2.EVENT_MOUSEMOVE:
        if drawing == True:
            # Vẽ hình chữ nhật từ điểm bắt đầu (ix, iy) đến điểm hiện tại (x, y)
            img_copy = img.copy()
            cv2.rectangle(img_copy, (ix, iy), (x, y), (0, 255, 0), 2)
            cv2.imshow('Image Viewer', img_copy)

    # Khi thả chuột
    elif event == cv2.EVENT_LBUTTONUP:
        drawing = False
        # Vẽ hình chữ nhật cuối cùng trên hình ảnh
        cv2.rectangle(img, (ix, iy), (x, y), (0, 255, 0), 2)
        cv2.imshow('Image Viewer', img)

def open_image_with_drawing(image_path):
    global img
    img = cv2.imread(image_path)
    cv2.imshow('Image Viewer', img)

    # Gán sự kiện chuột cho cửa sổ hiển thị
    cv2.setMouseCallback('Image Viewer', draw_rectangle)

    # Chờ người dùng nhấn 'q' để thoát
    while True:
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

    # Đóng cửa sổ khi hoàn tất
    cv2.destroyAllWindows()

def option_1():
    folder_path = input("Nhập đường dẫn thư mục chứa hình ảnh: ")

    if not os.path.exists(folder_path):
        print("Thư mục không tồn tại!")
        return

    # Lấy danh sách tất cả các tệp trong thư mục
    image_files = [f for f in os.listdir(folder_path) if f.endswith(('.png', '.jpg', '.jpeg'))]

    if not image_files:
        print("Không tìm thấy hình ảnh trong thư mục này.")
        return

    for image_file in image_files:
        image_path = os.path.join(folder_path, image_file)
        open_image_with_drawing(image_path)

def menu():
    print("---- Menu ----")
    print("1. Mở lần lượt hình ảnh trong một thư mục (khoanh vùng trên hình ảnh)")
    print("2. Tùy chọn 2")
    print("3. Tùy chọn 3")
    print("4. Thoát")

def main():
    while True:
        menu()
        choice = input("Chọn một tùy chọn: ")

        if choice == "1":
            option_1()
        elif choice == "2":
            print("Bạn đã chọn Tùy chọn 2")
        elif choice == "3":
            print("Bạn đã chọn Tùy chọn 3")
        elif choice == "4":
            print("Thoát chương trình")
            break
        else:
            print("Lựa chọn không hợp lệ. Vui lòng chọn lại.")

if __name__ == "__main__":
    main()
